# Implementation Plan: PencilHistory.xyz - Git 歷史視覺化檢視器

<!--
  憲章要求 (Constitution Requirement):
  本文件必須使用繁體中文（zh-TW）撰寫
  This document MUST be written in Traditional Chinese (zh-TW)
-->

**Branch**: `001-pen-history-viewer` | **Date**: 2026-02-24 | **Spec**: [spec.md](./spec.md)
**Input**: Feature specification from `/specs/001-pen-history-viewer/spec.md`

**Note**: This template is filled in by the `/speckit.plan` command. See `.specify/templates/plan-template.md` for the execution workflow.

## Summary

PencilHistory.xyz 是一個類似於 githistory.xyz 的網站應用程式，用於視覺化檢視 GitHub 上 .pen 設計檔案的 commit 歷史。使用者輸入 GitHub .pen 檔案 URL 後，系統會顯示該檔案的 commit 時間軸，並以視覺化方式呈現每個版本的設計內容（而非程式碼）。

**架構特點**：
- **前端**：Next.js 15 靜態網站，處理 UI、時間軸、使用者互動
- **後端**：Serverless API（Vercel Functions 或 Node.js server），整合 Pencil MCP server 生成 .pen 截圖
- **渲染策略**：透過後端呼叫 Pencil MCP 的 `get_screenshot` 工具，將 .pen 檔案轉換為截圖
- **快取策略**：積極快取截圖（IndexedDB + 記憶體），大幅減少 API 呼叫

系統採用 lazy loading 策略節省 API quota，使用匿名 GitHub API（60 請求/小時）。進階功能包括自動播放、鍵盤導航、時間軸滑桿，以及 node-level structural diff 的差異比較模式。

## Technical Context

**Language/Version**: TypeScript 5.x, Node.js 18+
**Package Manager**: npm 9.x+
**Primary Dependencies**:
- **Frontend**: Next.js 15 (App Router), React 18, Tailwind CSS v4, Octokit (GitHub API client)
- **Backend**: Pencil MCP Server (for .pen screenshot generation), @modelcontextprotocol/sdk
**Storage**:
- **Frontend**: IndexedDB (截圖快取，持久化), Memory cache (session 資料), LocalStorage (UI 偏好)
- **Backend**: 無狀態（stateless）serverless functions
**Testing**: Vitest (unit/integration), Playwright (E2E), React Testing Library
**Target Platform**:
- **Frontend**: 現代瀏覽器（Chrome 90+, Firefox 88+, Safari 14+, Edge 90+）
- **Backend**: Node.js 18+ runtime（Vercel Functions 或自架 server）
**Project Type**: Full-stack Web Application（前端靜態 + 後端 serverless API）
**Performance Goals**:
- URL 輸入到顯示時間軸 < 10 秒（100 commits）
- Commit 切換視覺化更新 < 2 秒（首次）、< 500ms（快取命中）
- FCP < 1.5s, TTI < 3.0s
- JavaScript bundle < 500KB gzipped
- Screenshot 生成 < 3 秒/檔案
**Constraints**:
- 僅支援 GitHub 公開儲存庫
- GitHub API 匿名呼叫限制 60 請求/小時/IP
- .pen 檔案大小上限 10MB
- Serverless function timeout < 10 秒（Vercel 限制）
**Scale/Scope**:
- 支援檢視至少 1000 筆 commit 歷史
- 每次載入 100 筆 commit（分頁）
- 預期並發使用者數：數百至數千
- Screenshot 服務 cold start < 5 秒

## Constitution Check

*GATE: Must pass before Phase 0 research. Re-check after Phase 1 design.*

根據憲章 v1.0.0 檢查以下項目：

### I. 程式碼品質 (Code Quality)
- [x] 程式碼結構清晰，遵循單一職責原則 - 使用 Next.js App Router 清晰分層
- [x] 避免過度工程化，只實作當前需求 - 無不必要的抽象層或框架
- [x] 配置 linting 工具（ESLint/Prettier 等） - 使用 Husky + ESLint + Prettier 作為 quality gate
- [x] 無明顯安全漏洞（OWASP Top 10） - 純前端靜態網站，無伺服器端攻擊面；輸入驗證防止 XSS

### II. 測試標準 (Testing Standards)
- [x] 計畫包含測試優先策略（Red-Green-Refactor） - 見 Phase 2 任務規劃
- [x] 識別需要契約測試的 API 端點 - GitHub API 回應格式、.pen 檔案結構驗證
- [x] 識別需要整合測試的使用者旅程 - P1/P2/P3 使用者故事全流程測試
- [x] 測試覆蓋率目標：核心業務邏輯 ≥ 80% - URL 解析、GitHub API 整合、.pen 渲染、diff 演算法

### III. 使用者體驗一致性 (UX Consistency)
- [x] 使用統一的設計系統（若有 UI 元件） - Tailwind v4 + 自訂 design tokens
- [x] 錯誤訊息和成功提示格式一致 - 統一的 ErrorBoundary 和 Toast 元件
- [x] 多語系支援完整（優先 zh-TW） - 此版本僅支援英文介面（類似 githistory.xyz），未來可擴展
- [x] 無障礙功能已考慮 - 鍵盤導航（方向鍵）、ARIA 標籤、focus management

### IV. 效能要求 (Performance Requirements)
- [x] API P95 延遲目標 < 200ms - 無自有 API，依賴 GitHub API（通常 < 200ms）
- [x] 前端 FCP < 1.5s, TTI < 3.0s（若適用） - Next.js SSG 優化，程式碼分割
- [x] JavaScript bundle < 500KB gzipped（若適用） - 使用 dynamic import、tree shaking、Pencil WASM 按需載入
- [x] 資料庫查詢已優化並使用索引 - N/A（無資料庫）
- [x] 已建立效能基準測試 - 使用 Lighthouse CI 和自訂效能測試

### V. 文件與可觀測性 (Documentation & Observability)
- [x] 所有文件使用繁體中文（zh-TW）撰寫 - spec.md、plan.md、tasks.md 均使用 zh-TW
- [x] 包含完整的 API 契約文件 - GitHub API 整合契約、.pen 檔案結構契約
- [x] 計畫包含結構化日誌策略（JSON 格式） - 前端使用 console 和 analytics events（結構化）
- [x] 關鍵操作有追蹤和計時 - Performance API 追蹤載入時間、渲染時間
- [x] 提供健康檢查端點（若適用） - N/A（靜態網站）

**違規項目記錄**：無違規項目

## Project Structure

### Documentation (this feature)

```text
specs/001-pen-history-viewer/
├── spec.md              # Feature specification (completed)
├── plan.md              # This file (in progress)
├── research.md          # Phase 0 output (to be generated)
├── data-model.md        # Phase 1 output (to be generated)
├── quickstart.md        # Phase 1 output (to be generated)
├── contracts/           # Phase 1 output (to be generated)
│   ├── github-api.md    # GitHub API integration contract
│   └── pen-file.md      # .pen file structure contract
└── tasks.md             # Phase 2 output (generated by /speckit.tasks)
```

### Source Code (repository root)

```text
pencil-history/
├── app/                          # Next.js 15 App Router
│   ├── layout.tsx               # Root layout
│   ├── page.tsx                 # Homepage (URL input)
│   ├── history/                 # History viewer route
│   │   └── [owner]/[repo]/[...path]/
│   │       └── page.tsx         # Dynamic route for history view
│   ├── api/                     # Serverless API Routes
│   │   └── screenshot/          # Pencil MCP screenshot endpoint
│   │       └── route.ts         # POST /api/screenshot
│   └── globals.css              # Tailwind v4 base styles
│
├── src/
│   ├── components/              # React components
│   │   ├── ui/                  # Basic UI components (Button, Input, etc.)
│   │   ├── timeline/            # Timeline components
│   │   │   ├── Timeline.tsx
│   │   │   ├── TimelineSlider.tsx
│   │   │   └── CommitNode.tsx
│   │   ├── viewer/              # .pen viewer components
│   │   │   ├── PenViewer.tsx
│   │   │   └── PenRenderer.tsx
│   │   ├── diff/                # Diff comparison components
│   │   │   ├── DiffView.tsx
│   │   │   └── DiffHighlight.tsx
│   │   └── layout/              # Layout components
│   │       ├── Header.tsx
│   │       ├── ErrorBoundary.tsx
│   │       └── LoadingSpinner.tsx
│   │
│   ├── lib/                     # Core business logic
│   │   ├── github/              # GitHub API integration
│   │   │   ├── client.ts        # Octokit wrapper
│   │   │   ├── parser.ts        # URL parser
│   │   │   ├── commits.ts       # Fetch commits
│   │   │   └── files.ts         # Fetch file content
│   │   ├── pen/                 # .pen file handling
│   │   │   ├── renderer.ts      # WASM renderer wrapper
│   │   │   ├── parser.ts        # .pen parser
│   │   │   └── cache.ts         # Memory cache
│   │   ├── diff/                # Diff algorithm
│   │   │   ├── node-diff.ts     # Node-level structural diff
│   │   │   └── types.ts         # Diff result types
│   │   └── utils/               # Utilities
│   │       ├── url.ts           # URL utilities
│   │       ├── errors.ts        # Error types
│   │       └── performance.ts   # Performance tracking
│   │
│   ├── hooks/                   # Custom React hooks
│   │   ├── useCommits.ts        # Fetch and manage commits
│   │   ├── usePenFile.ts        # Fetch and render .pen file
│   │   ├── useKeyboardNav.ts    # Keyboard navigation
│   │   └── usePlayback.ts       # Auto-playback control
│   │
│   ├── store/                   # State management (Zustand or Context)
│   │   ├── history-store.ts     # History viewer state
│   │   └── ui-store.ts          # UI preferences
│   │
│   └── types/                   # TypeScript types
│       ├── github.ts            # GitHub API types
│       ├── pen.ts               # .pen file types
│       └── app.ts               # Application types
│
├── public/                      # Static assets
│   ├── wasm/                    # Pencil WASM files
│   │   └── pencil-renderer.wasm
│   └── images/                  # Images and icons
│
├── tests/
│   ├── contract/                # Contract tests
│   │   ├── github-api.test.ts   # GitHub API contract
│   │   └── pen-file.test.ts     # .pen file structure
│   ├── integration/             # Integration tests
│   │   ├── user-story-1.test.ts # P1: View history timeline
│   │   ├── user-story-2.test.ts # P2: Navigate commits
│   │   └── user-story-3.test.ts # P3: Diff comparison
│   └── e2e/                     # E2E tests (Playwright)
│       ├── happy-path.spec.ts
│       └── error-handling.spec.ts
│
├── .husky/                      # Git hooks
│   ├── pre-commit               # ESLint + Prettier
│   └── pre-push                 # Run tests
│
├── next.config.js               # Next.js configuration
├── tailwind.config.js           # Tailwind v4 configuration
├── tsconfig.json                # TypeScript configuration
├── vitest.config.ts             # Vitest configuration
├── playwright.config.ts         # Playwright configuration
├── .eslintrc.json               # ESLint configuration
├── .prettierrc.json             # Prettier configuration
└── package.json                 # Dependencies
```

**Structure Decision**: 採用 Next.js 15 App Router 的單一專案結構，因為這是純前端靜態網站，無需分離 backend/frontend。使用 App Router 的檔案系統路由處理動態 URL（`/history/[owner]/[repo]/[...path]`），並透過 `src/` 目錄組織業務邏輯、元件、hooks 和測試。

## Complexity Tracking

此計畫無憲章違規項目，故本表格為空。

---

## Phase 0: Outline & Research

### Research Tasks

以下研究任務將產生 `research.md` 檔案：

1. **Pencil MCP Screenshot Service 整合研究**
   - 研究 Pencil MCP server 的 `get_screenshot` 工具 API
   - 研究如何在 Node.js 環境中啟動和呼叫 Pencil MCP server
   - 研究 Serverless function（Vercel Functions）整合 MCP server 的最佳實踐
   - 評估 screenshot 生成時間和快取策略

2. **GitHub API 最佳實踐研究**
   - 研究匿名 API 速率限制的具體行為和恢復時間
   - 研究如何高效擷取 commit 歷史（pagination, since/until parameters）
   - 研究如何最小化 API 呼叫次數（條件請求、ETag、Last-Modified）
   - 研究 GitHub API error handling 和 rate limit headers

3. **Node-level Structural Diff 演算法研究**
   - 研究現有的樹狀結構 diff 演算法（Myers diff, Tree diff, React reconciliation）
   - 評估適合 .pen 節點結構的 diff 演算法
   - 研究如何追蹤節點 ID 以準確識別修改（而非誤判為刪除+新增）
   - 研究差異視覺化的最佳實踐（highlight, side-by-side, overlay）

4. **Next.js 靜態網站最佳化研究**
   - 研究 Next.js 15 App Router 的 SSG（Static Site Generation）最佳實踐
   - 研究動態路由的 generateStaticParams 使用（若需預渲染部分頁面）
   - 研究 Code Splitting 和 Dynamic Import 最佳實踐
   - 研究 Tailwind v4 的最佳化配置（JIT mode, purge unused styles）

5. **前端快取策略研究**
   - 研究瀏覽器記憶體快取最佳實踐（Map vs WeakMap, cache eviction）
   - 研究 LocalStorage 與 SessionStorage 的適用場景
   - 研究 Service Worker 的可能性（未來增強）
   - 研究如何處理快取失效（檔案更新偵測）

6. **效能監控和追蹤研究**
   - 研究 Performance API 的使用（Navigation Timing, Resource Timing）
   - 研究如何追蹤使用者互動延遲（Time to Interactive, First Input Delay）
   - 研究 Lighthouse CI 整合到 GitHub Actions
   - 研究前端 error tracking（Sentry 等，但需考慮成本）

### Phase 0 Output

執行研究任務後，將產生 `/specs/001-pen-history-viewer/research.md`，包含：
- 每個研究任務的決策（Decision）
- 決策理由（Rationale）
- 評估過的替代方案（Alternatives Considered）

---

## Phase 1: Design & Contracts

### Phase 1 Tasks

1. **定義資料模型** (`data-model.md`)
   - 從 spec.md Key Entities 提取實體
   - 定義每個實體的欄位、型別、驗證規則
   - 定義實體之間的關聯（Repository → File → Commit → FileVersion）
   - 定義狀態轉換（若適用）

2. **定義介面契約** (`contracts/`)
   - **GitHub API 契約** (`contracts/github-api.md`)
     - 定義所需的 GitHub API 端點
     - 定義請求參數和回應格式
     - 定義錯誤處理和 rate limit headers
   - **.pen 檔案結構契約** (`contracts/pen-file.md`)
     - 定義 .pen 檔案的 JSON schema
     - 定義節點結構、屬性、ID 規則
     - 定義渲染所需的最小資訊

3. **建立快速入門指南** (`quickstart.md`)
   - 環境設定（Node.js, pnpm/npm）
   - 安裝相依套件
   - 開發伺服器啟動
   - 執行測試
   - 建置和部署

4. **更新 Agent Context**
   - 執行 `.specify/scripts/bash/update-agent-context.sh claude`
   - 新增技術堆疊資訊：
     - Next.js 15 (App Router)
     - React 18
     - Tailwind CSS v4
     - TypeScript 5.x
     - Vitest + Playwright
     - Husky + ESLint + Prettier

### Phase 1 Output

- `/specs/001-pen-history-viewer/data-model.md`
- `/specs/001-pen-history-viewer/contracts/github-api.md`
- `/specs/001-pen-history-viewer/contracts/pen-file.md`
- `/specs/001-pen-history-viewer/quickstart.md`
- `.specify/memory/agent-context-claude.md` (updated)

---

## Phase 2: Task Decomposition

**Note**: Phase 2（任務分解）由 `/speckit.tasks` 命令執行，不在 `/speckit.plan` 的範圍內。

此計畫完成後，使用者應執行：
```bash
/speckit.tasks
```

預期產生的任務結構：
- 按使用者故事分組（P1, P2, P3）
- 測試任務在實作任務之前
- 標註任務相依性和可平行執行的任務
- 預估任務複雜度（S/M/L）

---

## Next Steps

1. ✅ **Phase 0**: 執行研究任務，產生 `research.md`
2. ✅ **Phase 1**: 定義資料模型、契約、快速入門指南
3. ⏳ **Phase 2**: 執行 `/speckit.tasks` 產生任務清單
4. ⏳ **Implementation**: 執行 `/speckit.implement` 開始實作

**本計畫已完成 Phase 0 和 Phase 1 的規劃，接下來將執行研究和設計任務。**
